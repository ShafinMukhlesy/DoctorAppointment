@{
    ViewBag.Title = "Book Appointment - Step 1";
}

<div class="container mt-4">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">Book Appointment</h3>
        </div>
        <div class="card-body">
            @using (Html.BeginForm("SelectDoctor", "Appointment", FormMethod.Post))
            {
                <input type="hidden" id="SelectedTime" name="AppointmentTime" />

                <div class="row">
                    <!-- Left Column: Doctor Info + Schedule -->
                    <div class="col-lg-4 col-md-12 mb-4">
                        <div id="doctorDetails" class="card shadow-sm border-0 mb-3">
                            <div class="card-body text-center">
                                <img id="docImage" src="~/Uploads/Doctors/doctor.png" alt="Doctor Image"
                                     class="img-fluid rounded-circle mb-3 shadow"
                                     style="width:150px; height:150px; object-fit:cover;" />
                                <h5 id="docName" class="mb-1 text-primary"></h5>
                                <p id="docSpec" class="text-muted small"></p>
                                <hr />
                                <p><strong>Fee:</strong> <span id="docFee"></span></p>
                                <p><strong>Email:</strong> <span id="docEmail"></span></p>
                                <p><strong>Phone:</strong> <span id="docPhone"></span></p>
                            </div>
                        </div>

                        <!-- Doctor Schedule -->
                        <div id="docSchedule" class="card shadow-sm border-0">
                            <div class="card-body p-2">
                                <h6 class="text-primary mb-3">Doctor Schedule</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Day</th>
                                                <th>Time</th>
                                                <th>Max Patients</th>
                                                <th>Slot Duration</th>
                                            </tr>
                                        </thead>
                                        <tbody id="scheduleTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Appointment Form -->
                    <div class="col-lg-8 col-md-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="mb-3 text-secondary">Select Organization & Doctor</h5>

                                <div class="mb-3">
                                    @Html.Label("Organization", new { @class = "form-label fw-bold" })
                                    @Html.DropDownList("OrganizationId", (SelectList)ViewBag.Organizations, "-- Select Organization --", new { @class = "form-control" })
                                </div>

                                <div class="mb-3">
                                    @Html.Label("Department", new { @class = "form-label fw-bold" })
                                    <select id="DepartmentId" name="DepartmentId" class="form-control">
                                        <option>-- Select Department --</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    @Html.Label("Doctor", new { @class = "form-label fw-bold" })
                                    <select id="DoctorId" name="DoctorId" class="form-control">
                                        <option>-- Select Doctor --</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    @Html.Label("Appointment Date", new { @class = "form-label fw-bold" })
                                    @*<input type="date" id="AppointmentDate" name="AppointmentDate" class="form-control" />*@
                                    <input type="text" id="AppointmentDate" name="AppointmentDate" class="form-control" placeholder="Select date" autocomplete="off" />
                                </div>

                                <div id="timeSlotsContainer" class="mt-4">
                                    <h5 class="mb-3">Select Time Slot</h5>
                                    <div class="row" id="timeSlotsRow"></div>
                                </div>

                                <div class="text-end mt-3">
                                    <button type="submit" class="btn btn-primary px-4">
                                        Next <i class="bi bi-arrow-right-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Right Column -->
                </div>
            }
        </div>
    </div>
</div>

<style>
    #timeSlotsRow label.btn {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border-radius: 10px;
        font-size: 0.9rem;
    }

        #timeSlotsRow label.btn:hover {
            transform: scale(1.05);
        }

    #timeSlotsRow input[type=radio]:checked + div {
        font-weight: bold;
        color: white;
        background-color: #0d6efd;
        border-radius: 6px;
        padding: 4px;
    }

    #timeSlotsContainer {
        display: none;
    }
</style>

@section Scripts {


    <!-- jQuery (required first) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap JS (required) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Bootstrap Datepicker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>


    <script>
        $(document).ready(function () {



        $('#AppointmentDate').datepicker({
            format: 'yyyy-mm-dd',
            autoclose: true,
            todayHighlight: true,
            startDate: new Date(), // disable past dates
            daysOfWeekDisabled: [0, 1, 2, 3, 4, 5, 6] // initially disable all until doctor selected
        });


        var selectedOrg = '@ViewBag.SelectedOrganizationId';
        var selectedDept = '@ViewBag.SelectedDepartmentId';
        var selectedDoctor = '@ViewBag.SelectedDoctorId';

        if (selectedOrg) {
            $('#OrganizationId').val(selectedOrg);
            loadTimeSlots();
            // Load departments first
            $.getJSON('@Url.Action("GetDepartments")', { organizationId: selectedOrg }, function (data) {
                var options = '<option>-- Select Department --</option>';
                $.each(data, function (i, dept) {
                    options += '<option value="' + dept.DepartmentId + '">' + dept.Name + '</option>';
                });
                $('#DepartmentId').html(options);

                if (selectedDept) {
                    $('#DepartmentId').val(selectedDept);
                    loadTimeSlots();
                    // Load doctors next
                    $.getJSON('@Url.Action("GetDoctors")', { departmentId: selectedDept }, function (docs) {
                        var docOptions = '<option>-- Select Doctor --</option>';
                        $.each(docs, function (i, doc) {
                            docOptions += '<option value="' + doc.DoctorId + '">' + doc.Name + '</option>';
                        });
                        $('#DoctorId').html(docOptions);

                        if (selectedDoctor) {
                            $('#DoctorId').val(selectedDoctor);
                            getDoctordetails(selectedDoctor);
                            loadDoctorSchedule(selectedDoctor)//  existing function
                            loadTimeSlots(); // optional auto load
                        }
                    });
                }
            });
        }




        var nextBtn = $("button[type='submit']");
        nextBtn.prop("disabled", true);

    // Function to check if all required fields are selected
        function validateForm() {
            var org = $("#OrganizationId").val();
            var dept = $("#DepartmentId").val();
            var doctor = $("#DoctorId").val();
            var date = $("#AppointmentDate").val();
            var time = $("input[name='AppointmentTime']:checked").val(); // check selected time slot

            var allSelected = org && org !== "" &&
                              dept && dept !== "-- Select Department --" &&
                              doctor && doctor !== "-- Select Doctor --" &&
                              date && time;

            if (allSelected) {
                $("#validationMessage").remove();
                nextBtn.prop("disabled", false);
            } else {
                if ($("#validationMessage").length === 0) {
                    nextBtn.after('<p id="validationMessage" class="text-danger mt-2">Please select Organization, Department, Doctor, Appointment Date, and Time Slot.</p>');
                }
                nextBtn.prop("disabled", true);
            }
        }

    // Validate when any field changes or a time slot is selected
        $("#OrganizationId, #DepartmentId, #DoctorId, #AppointmentDate").change(validateForm);

        $(document).on("change", "input[name='AppointmentTime']", function () {
            $("#SelectedTime").val($(this).val());  // ✅ Sync hidden field
            console.log("Selected Time: " + $(this).val());
            validateForm();
        });

    // Existing code to load Departments, Doctors, Doctor Details, and Time Slots
        $("#OrganizationId").change(function () {
            var orgId = $(this).val();
            $("#DepartmentId").html('<option>Loading...</option>');
            $.getJSON('@Url.Action("GetDepartments")', { organizationId: orgId }, function (data) {
                var options = '<option>-- Select Department --</option>';
                $.each(data, function (i, dept) {
                    options += '<option value="' + dept.DepartmentId + '">' + dept.Name + '</option>';
                });
                $("#DepartmentId").html(options);
                $("#DoctorId").html('<option>-- Select Doctor --</option>');
                validateForm();
                loadTimeSlots();
            });
        });

        $("#DepartmentId").change(function () {
                $("#scheduleTableBody").html("<tr><td colspan='4' class='text-muted text-center'>No schedule available</td></tr>");
            var deptId = $(this).val();
            $("#DoctorId").html('<option>Loading...</option>');
            $.getJSON('@Url.Action("GetDoctors")', { departmentId: deptId }, function (data) {
                var options = '<option>-- Select Doctor --</option>';
                $.each(data, function (i, doc) {
                    options += '<option value="' + doc.DoctorId + '">' + doc.Name + '</option>';
                });
                $("#DoctorId").html(options);
                validateForm();
                loadTimeSlots();

            });
        });

        $("#DoctorId").change(function () {

            var docId = $(this).val();
            loadTimeSlots();
            getDoctordetails(docId)
        });


        function getDoctordetails(docId) {
            var docId = docId;

            if (docId && docId !== "-- Select Doctor --") {
                $.getJSON('@Url.Action("GetDoctorDetails")', { doctorId: docId }, function (data) {
                        if (data) {
                        $("#docImage").attr("src", data.Picture || "~/Uploads/Doctors/doctor.png");
                        $("#docName").text(data.Name);
                        $("#docSpec").text(data.Specialization);
                        $("#docFee").text(data.Fee);
                        $("#docEmail").text(data.Email);
                        $("#docPhone").text(data.Phone);
                        $("#doctorDetails").show();
                     }
                });

            } else {
                $("#doctorDetails").hide();
                }
            validateForm();
        }


        $("#DoctorId").change(function () {
            var val = $(this).val();
            loadDoctorSchedule(val);
            loadTimeSlots();

         });

            let availableDays = []; // to store doctor’s available weekdays (0–6)
            function loadDoctorSchedule(val) {

                var docId = val;
                var tableHtml = "";
                availableDays = [];


            if (docId && docId !== "-- Select Doctor --") {
                $.getJSON('@Url.Action("GetDoctorScheduleDetails")', { doctorId: docId }, function (data) {
                    if (data && data.length > 0) {
                        // Build table rows as string
                        $.each(data, function (i, sch) {
                            tableHtml +=
                                "<tr>" +
                                    "<td>" + sch.DayOfWeek + "</td>" +
                                    "<td>" + sch.StartTime + " - " + sch.EndTime + "</td>" +
                                    "<td>" + sch.MaxPatients + "</td>" +
                                    "<td>" + sch.SlotDuration + "</td>" +
                                "</tr>";

                            const dayIndex = getDayIndex(sch.DayOfWeek);
                            if (dayIndex != null) availableDays.push(dayIndex);

                            const disabledDays = [0, 1, 2, 3, 4, 5, 6].filter(d => !availableDays.includes(d));
                            $('#AppointmentDate').datepicker('setDaysOfWeekDisabled', disabledDays);

                        });
                    } else {
                        tableHtml = "<tr><td colspan='4' class='text-muted text-center'>No schedule available</td></tr>";
                    }

                    // Set table body HTML
                    $("#scheduleTableBody").html(tableHtml);

                    // Show doctor details section
                    $("#doctorDetails").show();
                });
            } else {
                // Hide doctor details if no doctor selected
                $("#doctorDetails").hide();
                $("#scheduleTableBody").html(""); // clear table
                $('#AppointmentDate').datepicker('setDaysOfWeekDisabled', [0, 1, 2, 3, 4, 5, 6]);
            }

          // Re-validate form (enable/disable Next button)
          validateForm();
        }

        function getDayIndex(dayName) {
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const index = days.findIndex(d => d.toLowerCase() === dayName.toLowerCase());
            return index === -1 ? null : index;
        }



    $("#AppointmentDate").change(function () {

        loadTimeSlots();
        validateForm();

    });

        function loadTimeSlots() {
            var doctorId = $("#DoctorId").val();
            var date = $("#AppointmentDate").val();
            if (doctorId && date) {
                $.getJSON('@Url.Action("GetAvailableSlotsforPatient")', { doctorId: doctorId, appointmentDate: date }, function (data) {
                    var slotsHtml = '';
                    $.each(data.AvailableSlots, function (i, slot) {
                        var isBooked = data.BookedSlots.includes(slot.Value);
                        var btnClass = isBooked ? 'btn-danger disabled' : 'btn-outline-primary';
                        slotsHtml += '<div class="col-2 mb-2">';
                        slotsHtml += '<label class="btn ' + btnClass + ' w-100 text-center">';
                        slotsHtml += '<input type="radio" name="AppointmentTime" value="' + slot.Value + '" ' + (isBooked ? 'disabled' : '') + ' />';
                        slotsHtml += '<div>' + slot.Text + '</div>';
                        slotsHtml += '</label></div>';
                    });
                    $("#timeSlotsRow").html(slotsHtml);
                    $("#timeSlotsContainer").show();
                    validateForm(); // validate after time slots load
                });
            }
        }

});

    </script>
}
