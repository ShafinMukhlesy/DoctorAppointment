@{
    ViewBag.Title = "Book Appointment - Step 1";
}

<div class="container mt-4">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">Book Appointment</h3>
        </div>
        <div class="card-body">
            @using (Html.BeginForm())
            {
                <input type="hidden" id="SelectedTime" name="AppointmentTime" />

                <div class="row">
                    <!-- Doctor Info Card on Left -->
                    <div class="col-md-4 mb-3">
                        <div id="doctorDetails" class="card shadow-sm border-0">
                            <div class="card-body text-center">
                                <img id="docImage" src="~/Uploads/Doctors/doctor.png" alt="Doctor Image"
                                     class="img-fluid rounded-circle mb-3 shadow"
                                     style="width:200px; height:200px; object-fit:cover;" />
                                <h4 id="docName" class="mb-1 text-primary"></h4>
                                <p id="docSpec" class="text-muted small"></p>
                                <hr />
                                <p><strong>Fee:</strong> <span id="docFee"></span></p>
                                <p><strong>Email:</strong> <span id="docEmail"></span></p>
                                <p><strong>Phone:</strong> <span id="docPhone"></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Form on Right -->
                    <div class="col-md-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="mb-3 text-secondary">Select Organization & Doctor</h5>

                                <div class="form-group mb-3">
                                    @Html.Label("Organization", new { @class = "form-label fw-bold" })
                                    @Html.DropDownList("OrganizationId", (SelectList)ViewBag.Organizations, "-- Select Organization --", new { @class = "form-control" })
                                </div>

                                <div class="form-group mb-3">
                                    @Html.Label("Department", new { @class = "form-label fw-bold" })
                                    <select id="DepartmentId" name="DepartmentId" class="form-control">
                                        <option>-- Select Department --</option>
                                    </select>
                                </div>

                                <div class="form-group mb-3">
                                    @Html.Label("Doctor", new { @class = "form-label fw-bold" })
                                    <select id="DoctorId" name="DoctorId" class="form-control">
                                        <option>-- Select Doctor --</option>
                                    </select>
                                </div>

                                <div class="form-group mb-4">
                                    @Html.Label("Appointment Date", new { @class = "form-label fw-bold" })
                                    <input type="date" id="AppointmentDate" name="AppointmentDate" class="form-control" />
                                </div>

                                <div id="timeSlotsContainer" class="mt-4">
                                    <h5 class="mb-3">Select Time Slot</h5>
                                    <div class="row" id="timeSlotsRow">
                                        <!-- Time slots will be loaded here dynamically -->
                                    </div>
                                </div>

                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary px-4">
                                        Next <i class="bi bi-arrow-right-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Inline styles so no section Styles is needed -->
<style>
    #timeSlotsRow label.btn {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border-radius: 10px;
        font-size: 0.9rem;
    }

        #timeSlotsRow label.btn:hover {
            transform: scale(1.05);
        }

    #timeSlotsRow input[type=radio]:checked + div {
        font-weight: bold;
        color: white;
        background-color: #0d6efd;
        border-radius: 6px;
        padding: 4px;
    }

    #timeSlotsContainer {
        display: none;
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {

            $("#AppointmentDate").change(loadTimeSlots);

            $(document).on("change", "input[name='AppointmentTime']", function () {
                $("#SelectedTime").val($(this).val());
                console.log("Selected Time: " + $(this).val());
            });

            // Load Departments when Organization changes
            $("#OrganizationId").change(function () {
                var orgId = $(this).val();
                $("#DepartmentId").html('<option>Loading...</option>');
                $.getJSON('@Url.Action("GetDepartments")', { organizationId: orgId }, function (data) {
                    var options = '<option>-- Select Department --</option>';
                    $.each(data, function (i, dept) {
                        options += '<option value="' + dept.DepartmentId + '">' + dept.Name + '</option>';
                    });
                    $("#DepartmentId").html(options);
                    $("#DoctorId").html('<option>-- Select Doctor --</option>');
                });
            });

            // Load Doctors when Department changes
            $("#DepartmentId").change(function () {
                var deptId = $(this).val();
                $("#DoctorId").html('<option>Loading...</option>');
                $.getJSON('@Url.Action("GetDoctors")', { departmentId: deptId }, function (data) {
                    var options = '<option>-- Select Doctor --</option>';
                    $.each(data, function (i, doc) {
                        options += '<option value="' + doc.DoctorId + '">' + doc.Name + '</option>';
                    });
                    $("#DoctorId").html(options);
                });
            });

            // Load Doctor Details when Doctor changes
            $("#DoctorId").change(function () {
                var docId = $(this).val();
                if (docId && docId !== "-- Select Doctor --") {
                    $.getJSON('@Url.Action("GetDoctorDetails")', { doctorId: docId }, function (data) {
                        if (data) {
                            $("#docImage").attr("src", data.Picture || "~/Uploads/Doctors/doctor.png");
                            $("#docName").text(data.Name);
                            $("#docSpec").text(data.Specialization);
                            $("#docFee").text(data.Fee);
                            $("#docEmail").text(data.Email);
                            $("#docPhone").text(data.Phone);
                            $("#doctorDetails").show();
                        }
                    });
                } else {
                    $("#doctorDetails").hide();
                }
            });

            // Load Time Slots when Doctor or Date changes
            function loadTimeSlots() {
                var doctorId = $("#DoctorId").val();
                var date = $("#AppointmentDate").val();
                if (doctorId && date) {
                    $.getJSON('@Url.Action("GetAvailableSlotsforPatient")', { doctorId: doctorId, appointmentDate: date }, function (data) {
                        var slotsHtml = '';
                        $.each(data.AvailableSlots, function (i, slot) {
                            var isBooked = data.BookedSlots.includes(slot.Value);
                            var btnClass = isBooked ? 'btn-danger disabled' : 'btn-outline-primary';
                            slotsHtml += '<div class="col-2 mb-2">';
                            slotsHtml += '<label class="btn ' + btnClass + ' w-100 text-center">';
                            slotsHtml += '<input type="radio" name="AppointmentTime" value="' + slot.Value + '" ' + (isBooked ? 'disabled' : '') + ' />';
                            slotsHtml += '<div>' + slot.Text + '</div>';
                            slotsHtml += '</label></div>';
                        });
                        $("#timeSlotsRow").html(slotsHtml);
                        $("#timeSlotsContainer").show();
                    });
                }
            }
        });
    </script>
}
