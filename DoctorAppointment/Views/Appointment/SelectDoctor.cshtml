@{
    ViewBag.Title = "Book Appointment - Step 1";
}

<div class="container mt-4">
    <div class="card shadow-lg border-0">
        <div class="card-header bg-primary text-white text-center">
            <h3 class="mb-0">Book Appointment</h3>
        </div>
        <div class="card-body">
            @using (Html.BeginForm())
            {
                <input type="hidden" id="SelectedTime" name="AppointmentTime" />

                <div class="row">
                    <!-- Doctor Info Card on Left -->
                    <div class="col-md-4 mb-3">
                        <div id="doctorDetails" class="card shadow-sm border-0">
                            <div class="card-body text-center">
                                <img id="docImage" src="~/Uploads/Doctors/doctor.png" alt="Doctor Image"
                                     class="img-fluid rounded-circle mb-3 shadow"
                                     style="width:200px; height:200px; object-fit:cover;" />
                                <h4 id="docName" class="mb-1 text-primary"></h4>
                                <p id="docSpec" class="text-muted small"></p>
                                <hr />
                                <p><strong>Fee:</strong> <span id="docFee"></span></p>
                                <p><strong>Email:</strong> <span id="docEmail"></span></p>
                                <p><strong>Phone:</strong> <span id="docPhone"></span></p>
                            </div>
                        </div>
                    </div>
                    <!-- Doctor Schedule -->
                    <div id="docSchedule" class="text-start mt-2">
                        <h6 class="text-primary">Doctor Schedule</h6>
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Day</th>
                                    <th>Time</th>
                                    <th>Max Patients</th>
                                    <th>Slot Duration (min)</th>
                                </tr>
                            </thead>
                            <tbody id="scheduleTableBody"></tbody>
                        </table>
                    </div>

                    <!-- Form on Right -->
                    <div class="col-md-8">
                        <div class="card shadow-sm border-0">
                            <div class="card-body">
                                <h5 class="mb-3 text-secondary">Select Organization & Doctor</h5>

                                <div class="form-group mb-3">
                                    @Html.Label("Organization", new { @class = "form-label fw-bold" })
                                    @Html.DropDownList("OrganizationId", (SelectList)ViewBag.Organizations, "-- Select Organization --", new { @class = "form-control" })
                                </div>

                                <div class="form-group mb-3">
                                    @Html.Label("Department", new { @class = "form-label fw-bold" })
                                    <select id="DepartmentId" name="DepartmentId" class="form-control">
                                        <option>-- Select Department --</option>
                                    </select>
                                </div>

                                <div class="form-group mb-3">
                                    @Html.Label("Doctor", new { @class = "form-label fw-bold" })
                                    <select id="DoctorId" name="DoctorId" class="form-control">
                                        <option>-- Select Doctor --</option>
                                    </select>
                                </div>

                                <div class="form-group mb-4">
                                    @Html.Label("Appointment Date", new { @class = "form-label fw-bold" })
                                    <input type="date" id="AppointmentDate" name="AppointmentDate" class="form-control" />
                                </div>

                                <div id="timeSlotsContainer" class="mt-4">
                                    <h5 class="mb-3">Select Time Slot</h5>
                                    <div class="row" id="timeSlotsRow">
                                        <!-- Time slots will be loaded here dynamically -->
                                    </div>
                                </div>

                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary px-4">
                                        Next <i class="bi bi-arrow-right-circle"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Inline styles so no section Styles is needed -->
<style>
    #timeSlotsRow label.btn {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
        border-radius: 10px;
        font-size: 0.9rem;
    }

        #timeSlotsRow label.btn:hover {
            transform: scale(1.05);
        }

    #timeSlotsRow input[type=radio]:checked + div {
        font-weight: bold;
        color: white;
        background-color: #0d6efd;
        border-radius: 6px;
        padding: 4px;
    }

    #timeSlotsContainer {
        display: none;
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
       $(document).ready(function () {

    var nextBtn = $("button[type='submit']");
    nextBtn.prop("disabled", true);

    // Function to check if all required fields are selected
    function validateForm() {
        var org = $("#OrganizationId").val();
        var dept = $("#DepartmentId").val();
        var doctor = $("#DoctorId").val();
        var date = $("#AppointmentDate").val();
        var time = $("input[name='AppointmentTime']:checked").val(); // check selected time slot

        var allSelected = org && org !== "" &&
                          dept && dept !== "-- Select Department --" &&
                          doctor && doctor !== "-- Select Doctor --" &&
                          date && time;

        if (allSelected) {
            $("#validationMessage").remove();
            nextBtn.prop("disabled", false);
        } else {
            if ($("#validationMessage").length === 0) {
                nextBtn.after('<p id="validationMessage" class="text-danger mt-2">Please select Organization, Department, Doctor, Appointment Date, and Time Slot.</p>');
            }
            nextBtn.prop("disabled", true);
        }
    }

    // Validate when any field changes or a time slot is selected
           $("#OrganizationId, #DepartmentId, #DoctorId, #AppointmentDate").change(validateForm);

           $(document).on("change", "input[name='AppointmentTime']", function () {
               $("#SelectedTime").val($(this).val());  // ✅ Sync hidden field
               console.log("Selected Time: " + $(this).val());
               validateForm();
           });

    // Existing code to load Departments, Doctors, Doctor Details, and Time Slots
    $("#OrganizationId").change(function () {
        var orgId = $(this).val();
        $("#DepartmentId").html('<option>Loading...</option>');
        $.getJSON('@Url.Action("GetDepartments")', { organizationId: orgId }, function (data) {
            var options = '<option>-- Select Department --</option>';
            $.each(data, function (i, dept) {
                options += '<option value="' + dept.DepartmentId + '">' + dept.Name + '</option>';
            });
            $("#DepartmentId").html(options);
            $("#DoctorId").html('<option>-- Select Doctor --</option>');
            validateForm();
        });
    });

    $("#DepartmentId").change(function () {
        var deptId = $(this).val();
        $("#DoctorId").html('<option>Loading...</option>');
        $.getJSON('@Url.Action("GetDoctors")', { departmentId: deptId }, function (data) {
            var options = '<option>-- Select Doctor --</option>';
            $.each(data, function (i, doc) {
                options += '<option value="' + doc.DoctorId + '">' + doc.Name + '</option>';
            });
            $("#DoctorId").html(options);
            validateForm();
        });
    });

    $("#DoctorId").change(function () {
        var docId = $(this).val();
        if (docId && docId !== "-- Select Doctor --") {
            $.getJSON('@Url.Action("GetDoctorDetails")', { doctorId: docId }, function (data) {
                if (data) {
                    $("#docImage").attr("src", data.Picture || "~/Uploads/Doctors/doctor.png");
                    $("#docName").text(data.Name);
                    $("#docSpec").text(data.Specialization);
                    $("#docFee").text(data.Fee);
                    $("#docEmail").text(data.Email);
                    $("#docPhone").text(data.Phone);
                    $("#doctorDetails").show();
                }
            });
        } else {
            $("#doctorDetails").hide();
        }
        validateForm();
    });



$("#DoctorId").change(function () {
    var docId = $(this).val();

    var tableHtml = "";

    if (docId && docId !== "-- Select Doctor --") {
        $.getJSON('@Url.Action("GetDoctorScheduleDetails")', { doctorId: docId }, function (data) {
            if (data && data.length > 0) {
                // Build table rows as string
                $.each(data, function (i, sch) {
                    tableHtml +=
                        "<tr>" +
                            "<td>" + sch.DayOfWeek + "</td>" +
                            "<td>" + sch.StartTime + " - " + sch.EndTime + "</td>" +
                            "<td>" + sch.MaxPatients + "</td>" +
                            "<td>" + sch.SlotDuration + "</td>" +
                        "</tr>";
                });
            } else {
                tableHtml = "<tr><td colspan='4' class='text-muted text-center'>No schedule available</td></tr>";
            }

            // Set table body HTML
            $("#scheduleTableBody").html(tableHtml);

            // Show doctor details section
            $("#doctorDetails").show();
        });
    } else {
        // Hide doctor details if no doctor selected
        $("#doctorDetails").hide();
        $("#scheduleTableBody").html(""); // clear table
    }

    // Re-validate form (enable/disable Next button)
    validateForm();
});




    $("#AppointmentDate").change(function () {
        loadTimeSlots();
        validateForm();
    });

    function loadTimeSlots() {
        var doctorId = $("#DoctorId").val();
        var date = $("#AppointmentDate").val();
        if (doctorId && date) {
            $.getJSON('@Url.Action("GetAvailableSlotsforPatient")', { doctorId: doctorId, appointmentDate: date }, function (data) {
                var slotsHtml = '';
                $.each(data.AvailableSlots, function (i, slot) {
                    var isBooked = data.BookedSlots.includes(slot.Value);
                    var btnClass = isBooked ? 'btn-danger disabled' : 'btn-outline-primary';
                    slotsHtml += '<div class="col-2 mb-2">';
                    slotsHtml += '<label class="btn ' + btnClass + ' w-100 text-center">';
                    slotsHtml += '<input type="radio" name="AppointmentTime" value="' + slot.Value + '" ' + (isBooked ? 'disabled' : '') + ' />';
                    slotsHtml += '<div>' + slot.Text + '</div>';
                    slotsHtml += '</label></div>';
                });
                $("#timeSlotsRow").html(slotsHtml);
                $("#timeSlotsContainer").show();
                validateForm(); // validate after time slots load
            });
        }
    }

});

    </script>
}
